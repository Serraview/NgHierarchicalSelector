angular.module("hierarchical-selector",["hierarchical-selector.tree-item","hierarchical-selector.selectorUtils"]).directive("hierarchicalSelector",["$compile","$timeout","$q","selectorUtils",function(e,t,n,a){return{restrict:"E",replace:!0,templateUrl:"hierarchical-selector.tpl.html",scope:{syncData:"=data",multiSelect:"=?",onSelectionChanged:"&",selectOnlyLeafs:"=?",canSelectItem:"&",loadChildItems:"&",itemHasChildren:"&",selection:"=",tagName:"&",placeholder:"@"},link:function(e,t,a){a.canSelectItem&&(e.useCanSelectItemCallback=!0),a.loadChildItems&&(e.isAsync=!0),void 0===a.noButton&&(e.showButton=!0),a.tagName&&(e.useTagName=!0),!e.syncData&&e.isAsync&&(e.dataLoadPromise=n.when(e.loadChildItems({parent:null})).then(function(t){e.data=t})),e.syncData&&(e.data=e.syncData,e.$watch("syncData",function(){e.data=e.syncData}))},controller:["$scope","$document","$window","$interpolate",function(e,n,i,c){function l(t){s(),e.$apply()}function s(){if(e.showTree=!1,f){var t=a.getMetaData(f);t.isActive=!1,f=void 0}e.asyncChildCache={},n.off("click",l),n.off("keydown",p),e.$parent.onViewClosed&&e.$parent.onViewClosed()}function r(t,n){n||(n=e.data);for(var i=0;i<n.length;i++){var c=n[i];if(c.id===t)return c;var l=a.getChildren(c,e.isAsync,e.asyncChildCache);if(l){var s=r(t,l);if(s)return s}}return null}function d(e){return function(t){return t.id===e}}function o(t,n,i,c){if(n){var l=n.indexOf(t);if(l>-1)return{currentArray:n,parentArray:i,parentIndex:c,itemIndex:l};for(var s,r=0;r<n.length&&(!a.hasChildren(n[r],e.isAsync)||!(s=o(t,a.getChildren(n[r],e.isAsync,e.asyncChildCache),n,r)));r++);return s}}function m(t){var n=a.getChildren(t,e.isAsync,e.asyncChildCache),i=n[n.length-1];return a.getMetaData(i).isExpanded?m(i):i}function h(t,n,i){var c=o(n,i),l=a.getMetaData(n);if(t){if(l.isExpanded)return a.getChildren(n,e.isAsync,e.asyncChildCache)[0];if(c.itemIndex<c.currentArray.length-1)return c.currentArray[c.itemIndex+1];if(c.itemIndex==c.currentArray.length-1&&c.parentArray&&c.parentIndex<c.parentArray.length-1)return c.parentArray[c.parentIndex+1]}else{if(c.itemIndex>0){var s=c.currentArray[c.itemIndex-1];return a.getMetaData(s).isExpanded?m(s):s}if(0===c.itemIndex&&c.parentArray)return c.parentArray[c.parentIndex]}return n}function u(t){f?e.onActiveItem(h(t,f,e.data)):(idx=t?0:e.data.length-1,e.onActiveItem(e.data[idx])),e.$apply()}function p(t){switch(t.keyCode){case 27:t.preventDefault(),t.stopPropagation(),s(),e.$apply();break;case 32:case 13:t.preventDefault(),t.stopPropagation(),f&&(e.itemSelected(f),e.$apply());break;case 40:t.preventDefault(),t.stopPropagation(),u(!0);break;case 38:t.preventDefault(),t.stopPropagation(),u(!1);break;case 37:t.preventDefault(),t.stopPropagation(),f&&(a.getMetaData(f).isExpanded=!1,e.$apply());break;case 39:t.preventDefault(),t.stopPropagation(),f&&(a.getMetaData(f).isExpanded=!0,e.$apply())}}var f;e.showTree=!1,e.selectedItems=[],e.multiSelect=e.multiSelect||!1,e.asyncChildCache={},e.onActiveItem=function(e){if(f!=e){if(f){var t=a.getMetaData(f);t.isActive=!1}f=e;var n=a.getMetaData(f);n.isActive=!0}},e.expandParents=function(){if(e.isAsync)for(var t=0;t<e.selectedItems.length;t++){var n=e.selectedItems[t];if(n.id){for(var i=n;i;){var c=r(i.id);if(c&&!a.getMetaData(c).isExpanded)break;i=i.parent}if(i&&i.id)if(i===n){var l=r(n.id);if(e.multiSelect||n===l){a.getMetaData(l).selected=!0;continue}e.itemSelected(l,!0)}else{var s=r(i.id);if(s){var d=a.getMetaData(s);d.isExpanded||(d.isExpanded=!0)}}}}},e.childExpanded=function(){t(e.expandParents)},e.deselectItem=function(t,n){if(n.stopPropagation(),e.multiSelect){var i;for(var c in e.selectedItems)a.getMetaData(e.selectedItems[c]).selected=!1;e.selectedItems=[]}else{e.selectedItems.splice(e.selectedItems.indexOf(t),1);var i=a.getMetaData(t);i.selected=!1}e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0}),s()},e.onButtonClicked=function(t){e.showTree?s():e.onControlClicked(t)},e.onControlClicked=function(t){t.stopPropagation(),e.showTree||(e.showTree=!0,n.on("click",l),n.on("keydown",p))},e.itemSelected=function(n,i){if(angular.isArray(n)){for(var c=0;c<n.length;c++)if(e.useCanSelectItemCallback&&e.canSelectItem({item:n[c]})===!1||e.selectOnlyLeafs&&a.hasChildren(n[c],e.isAsync))return}else if(e.useCanSelectItemCallback&&e.canSelectItem({item:n})===!1||e.selectOnlyLeafs&&a.hasChildren(n,e.isAsync))return;e.dataLoadPromise.then(function(){angular.isArray(n)||(n=[n]);for(var c=0;c<n.length;c++){var l=a.getMetaData(n[c]);if(e.multiSelect){var r=e.selectedItems.findIndex(d(n[c].id));r>-1?(l.selected=!1,e.selectedItems.splice(r,1)):(l.selected=!0,e.selectedItems.push(n[c]))}else{i||s();for(var o=0;o<e.selectedItems.length;o++)a.getMetaData(e.selectedItems[o]).selected=!1;l.selected=!0,e.selectedItems=[],e.selectedItems.push(n[c])}}e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0}),t(e.expandParents)})},e.clearSelection=function(){e.selectedItems=[],e.onSelectionChanged&&e.onSelectionChanged({items:void 0})},e.$watch("selection",function(t,n){t?e.itemSelected(angular.copy(t)):e.selectedItems.length>0&&e.clearSelection()}),e.getTagName=function(t){return e.useTagName?e.tagName({item:t}):t.name}}]}}]),angular.module("hierarchical-selector.selectorUtils",[]).factory("selectorUtils",["$q",function(e){return{getMetaPath:function(){return"_hsmeta"},getMetaData:function(e){return e._hsmeta||(e._hsmeta={}),e._hsmeta},hasChildren:function(e,t){return t?e.hasChildren:e.children&&e.children.length>0},getChildren:function(e,t,n){var a=t?n[e.$$hashKey]:e.children;return t&&!a&&e.hasChildren?[]:a}}}]),angular.module("hierarchical-selector.tree-item",["hierarchical-selector.selectorUtils"]).directive("treeItem",["$compile","$q","selectorUtils",function(e,t,n){return{restrict:"E",replace:!0,templateUrl:"tree-item.tpl.html",scope:{item:"=",itemSelected:"&",onActiveItem:"&",multiSelect:"=?",isActive:"=",selectOnlyLeafs:"=?",useCanSelectItem:"=",canSelectItem:"=",loadChildItems:"=",itemHasChildren:"&",onExpanded:"&",async:"=",asyncChildCache:"="},controller:["$scope",function(e){e.metaData=n.getMetaData(e.item),e.metaData.isExpanded=!1,e.theChildren=e.item.children,e.showExpando=function(t){return n.hasChildren(t,e.async)},e.onExpandoClicked=function(e,t){t.stopPropagation();var a=n.getMetaData(e);a.isExpanded=!a.isExpanded},e.clickSelectItem=function(t,n){n.stopPropagation(),e.itemSelected&&e.itemSelected({item:t})},e.subItemSelected=function(t,n){e.itemSelected&&e.itemSelected({item:t})},e.activeSubItem=function(t,n){e.onActiveItem&&e.onActiveItem({item:t})},e.handleOnExpanded=function(t,n){e.onExpanded&&e.onExpanded()},e.onMouseOver=function(t){t.stopPropagation(),angular.isFunction(e.onActiveItem)&&e.onActiveItem({item:e.item})},e.showCheckbox=function(){return!!e.multiSelect&&(e.useCanSelectItem?e.canSelectItem({item:e.item}):!e.selectOnlyLeafs||e.selectOnlyLeafs&&!n.hasChildren(e.item,e.async))}}],compile:function(t,a,i){angular.isFunction(i)&&(i={post:i});var c,l=t.contents().remove();return{pre:i&&i.pre?i.pre:null,post:function(t,a,s){c||(c=e(l)),c(t,function(e){a.append(e)}),i&&i.post&&i.post.apply(null,arguments),t.async&&t.$watch("item."+n.getMetaPath()+".isExpanded",function(e){if(e){if(t.asyncChildCache[t.item.$$hashKey])return void(t.theChildren=t.asyncChildCache[t.item.$$hashKey]);if(t.theChildren=[{placeholder:!0}],angular.isFunction(t.loadChildItems)&&t.item){var n=t.loadChildItems({parent:t.item});angular.isArray(n)&&(t.theChildren=n,t.onExpanded&&t.onExpanded()),n.then(function(e){t.theChildren=e,t.asyncChildCache[t.item.$$hashKey]=e,t.onExpanded&&t.onExpanded()})}}})}}}}}]),angular.module("hierarchical-selector").run(["$templateCache",function(e){e.put("hierarchical-selector.tpl.html",'<div class="hierarchical-control">\r\n  <div class="control-group">\r\n    <button type="button" ng-if="showButton" class="pull-down" ng-click="onButtonClicked($event)"><div class="arrow-down"></div></button>\r\n    <div class="hierarchical-input form-control" ng-class="{\'with-btn\': showButton}" ng-click="onControlClicked($event)">\r\n      <span ng-if="selectedItems.length == 0" class="placeholder">{{placeholder}}</span>\r\n      <span ng-if="selectedItems.length > 0" class="selected-items">\r\n        <span ng-repeat="i in selectedItems" class="selected-item">{{getTagName(i)}} <span class="selected-item-close" ng-click="deselectItem(i, $event)"></span></span>\r\n      </span>\r\n      <!-- <input type="text" class="blend-in" /> -->\r\n    </div>\r\n  </div>\r\n  <div class="tree-view-outer" ng-show="showTree">\r\n    <div class="tree-view" ng-show="showTree">\r\n      <ul>\r\n        <tree-item class="top-level" on-expanded="childExpanded(item)" ng-repeat="item in data" item="item" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItemCallback" can-select-item="canSelectItem" multi-select="multiSelect" item-selected="itemSelected(item)" on-active-item="onActiveItem(item)" load-child-items="loadChildItems" async="isAsync" item-has-children="hasChildren(parent)" async-child-cache="asyncChildCache" />\r\n      </ul>\r\n    </div>\r\n  </div>\r\n</div>\r\n'),e.put("tree-item.tpl.html",'<li>\r\n  <div class="item-container" ng-class="{active: metaData.isActive, selected: metaData.selected}" ng-mouseover="onMouseOver($event)" ng-click="clickSelectItem(item, $event)">\r\n    <span ng-if="showExpando(item)" class="expando" ng-class="{\'expando-opened\': metaData.isExpanded}" ng-click="onExpandoClicked(item, $event)"></span><div class="item-details">{{item.name}}</div>\r\n  </div>\r\n  <ul ng-repeat="child in theChildren" ng-if="metaData.isExpanded">\r\n    <div ng-if="child.placeholder" class="loading">Loading...</div>\r\n    <tree-item on-expanded="handleOnExpanded(item)" ng-if="!child.placeholder" item="child" item-selected="subItemSelected(item)" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItem" can-select-item="canSelectItem" multi-select="multiSelect" on-active-item="activeSubItem(item, $event)" load-child-items="loadChildItems" async="async" async-child-cache="asyncChildCache" />\r\n  </ul>\r\n</li>\r\n')}]);